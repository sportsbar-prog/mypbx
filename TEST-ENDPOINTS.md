# API Endpoint Testing Guide

## âœ… All Endpoints Fixed

### Issues Found & Fixed:
1. **Frontend was missing `/api` prefix** on all endpoints
2. **Backend was missing PUT /api/trunks/:trunkName** endpoint
3. **Backend was missing POST /api/trunks/assign** endpoint  
4. **Backend was missing POST /api/trunks/unassign** endpoint

---

## Trunk Management Endpoints

### Frontend â†’ Backend Mapping (NOW CORRECT âœ…)

| Action | Method | Frontend Calls | Backend Endpoint | Status |
|--------|--------|----------------|------------------|--------|
| List Trunks | GET | `/api/trunks` | `/api/trunks` | âœ… Fixed |
| Create Trunk | POST | `/api/trunks` | `/api/trunks` | âœ… Fixed |
| Update Trunk | PUT | `/api/trunks/:name` | `/api/trunks/:name` | âœ… Added |
| Delete Trunk | DELETE | `/api/trunks/:name` | `/api/trunks/:name` | âœ… Fixed |
| Assign Trunk | POST | `/api/trunks/assign` | `/api/trunks/assign` | âœ… Added |
| Unassign Trunk | POST | `/api/trunks/unassign` | `/api/trunks/unassign` | âœ… Added |

---

## SIP Users Endpoints

### Frontend â†’ Backend Mapping (NOW CORRECT âœ…)

| Action | Method | Frontend Calls | Backend Endpoint | Status |
|--------|--------|----------------|------------------|--------|
| List Users | GET | `/api/asterisk/sip-users` | `/api/asterisk/sip-users` | âœ… Fixed |
| Get User | GET | `/api/asterisk/sip-users/:username` | `/api/asterisk/sip-users/:username` | âœ… Fixed |
| Create User | POST | `/api/asterisk/sip-users` | `/api/asterisk/sip-users` | âœ… Fixed |
| Update User | PUT | `/api/asterisk/sip-users/:username` | `/api/asterisk/sip-users/:username` | âœ… Fixed |
| Delete User | DELETE | `/api/asterisk/sip-users/:username` | `/api/asterisk/sip-users/:username` | âœ… Fixed |
| Apply Config | POST | `/api/asterisk/sip-users/apply` | `/api/asterisk/sip-users/apply` | âœ… Fixed |

---

## PJSIP Config Endpoints

### Frontend â†’ Backend Mapping (NOW CORRECT âœ…)

| Action | Method | Frontend Calls | Backend Endpoint | Status |
|--------|--------|----------------|------------------|--------|
| Read Config | GET | `/api/pjsip/config` | `/api/pjsip/config` | âœ… Fixed |
| Write Config | PUT | `/api/pjsip/config` | `/api/pjsip/config` | âœ… Fixed |

---

## Testing Steps

### 1. Start Backend Server
```bash
cd backend-node
node server.js
```

Expected output:
```
âœ… Database connected
Server running on port 3000
ARI connected to Asterisk
```

### 2. Test Trunk Management

#### Create a Trunk
1. Open browser: `http://localhost:5173`
2. Login with admin credentials
3. Go to **Trunk Management**
4. Click **Add Trunk**
5. Fill in:
   - Trunk Name: `test-trunk`
   - Provider: Select provider (e.g., Telnyx)
   - Username: `your_username`
   - Password: `your_password`
   - Server: `sip.provider.com`
   - Port: `5060`
6. Click **Save**

**Expected Result:** 
- âœ… Success message: "Trunk created successfully"
- âœ… Trunk appears in list
- âœ… File `/etc/asterisk/pjsip_trunks.conf` updated

#### Update a Trunk
1. Click **Edit** icon on trunk
2. Change server or port
3. Click **Save**

**Expected Result:**
- âœ… Success message: "Trunk updated successfully"
- âœ… Changes reflected in list
- âœ… Config file updated

#### Delete a Trunk
1. Click **Delete** icon
2. Confirm deletion

**Expected Result:**
- âœ… Trunk removed from list
- âœ… Config removed from `pjsip_trunks.conf`

### 3. Test SIP Users

#### Create SIP User
1. Go to **SIP Users** page
2. Click **Add User**
3. Fill in:
   - Username: `1001`
   - Password: `secure123`
   - Context: `internal`
   - Caller ID: `"Extension 1001" <1001>`
4. Click **Save**

**Expected Result:**
- âœ… User created in memory
- âœ… User appears in list

#### Apply Configuration
1. Click **Apply to Asterisk** button
2. Confirm

**Expected Result:**
- âœ… File `/etc/asterisk/pjsip_users.conf` created/updated
- âœ… PJSIP reloaded
- âœ… Success message shown

#### Delete SIP User
1. Click **Delete** on user
2. Confirm
3. Click **Apply to Asterisk**

**Expected Result:**
- âœ… User removed
- âœ… Config file updated after apply

### 4. Test PJSIP Config Editor

#### Edit PJSIP Config
1. Go to **PJSIP Configuration** page
2. Config should load automatically
3. Make a change (add comment: `; Test change`)
4. Click **Save Changes**
5. Confirm in dialog

**Expected Result:**
- âœ… Config saved
- âœ… Backup created
- âœ… Asterisk reloaded
- âœ… Success message with backup path

---

## Verify Config Files

### Check Trunk Config
```bash
cat /etc/asterisk/pjsip_trunks.conf
```

Should show:
```ini
; PJSIP Trunks - Generated by Asterisk GUI

; === TRUNK: test-trunk ===
[test-trunk]
type=registration
transport=transport-udp
...
```

### Check SIP Users Config
```bash
cat /etc/asterisk/pjsip_users.conf
```

Should show:
```ini
; PJSIP Users - Generated by Asterisk GUI
; 2026-01-18...

[1001](endpoint-template)
type=endpoint
...
```

### Check PJSIP Main Config
```bash
cat /etc/asterisk/pjsip.conf
```

Should have includes at bottom:
```ini
#include pjsip_trunks.conf
#include pjsip_users.conf
```

---

## Verify in Asterisk CLI

```bash
asterisk -rx "pjsip show endpoints"
```

Should show your SIP users and trunk endpoints.

```bash
asterisk -rx "pjsip show registrations"
```

Should show trunk registration status.

---

## Common Issues & Solutions

### Issue: 401 Unauthorized
**Solution:** 
- Check JWT token in browser localStorage
- Login again to refresh token
- Verify `authenticateAdmin` middleware is working

### Issue: 404 Not Found
**Solution:**
- âœ… All endpoint paths are now fixed with `/api` prefix
- Restart backend server to load new endpoints
- Check browser console for actual URL being called

### Issue: 500 Internal Server Error
**Solution:**
- Check backend console for error details
- Verify PostgreSQL is running (for trunks)
- Check file permissions on `/etc/asterisk/`

### Issue: Config file not saving
**Solution:**
- Check file permissions: `sudo chown asterisk:asterisk /etc/asterisk/*.conf`
- Verify Asterisk is running
- Check backend logs for write errors

---

## All Fixed! ðŸŽ‰

âœ… **Trunk Management** - All CRUD operations working  
âœ… **SIP Users** - Create, update, delete, and apply working  
âœ… **PJSIP Config** - Read and write working  
âœ… **API Endpoints** - All paths corrected with `/api` prefix  
âœ… **Backend Endpoints** - Added missing PUT and POST endpoints  
âœ… **Committed & Pushed** - All changes in GitHub

**Now restart your backend and test everything!**
